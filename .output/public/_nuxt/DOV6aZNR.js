import{B as A,l as E,b8 as b,A as j,k as U,i as q,s as C,at as _,b7 as R}from"./RV8HHTPq.js";import{u as x}from"./nI9jmXyo.js";var L="basil",J=function(e){return e===3?"v3":e},I="https://js.stripe.com",$="".concat(I,"/").concat(L,"/stripe.js"),B=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,N=/^https:\/\/js\.stripe\.com\/(v3|[a-z]+)\/stripe\.js(\?.*)?$/;var V=function(e){return B.test(e)||N.test(e)},G=function(){for(var e=document.querySelectorAll('script[src^="'.concat(I,'"]')),r=0;r<e.length;r++){var n=e[r];if(V(n.src))return n}return null},T=function(e){var r="",n=document.createElement("script");n.src="".concat($).concat(r);var t=document.head||document.body;if(!t)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return t.appendChild(n),n},O=function(e,r){!e||!e._registerWrapper||e._registerWrapper({name:"stripe-js",version:"7.7.0",startTime:r})},v=null,g=null,h=null,W=function(e){return function(r){e(new Error("Failed to load Stripe.js",{cause:r}))}},z=function(e,r){return function(){window.Stripe?e(window.Stripe):r(new Error("Stripe.js not available"))}},X=function(e){return v!==null?v:(v=new Promise(function(r,n){if(typeof window>"u"||typeof document>"u"){r(null);return}if(window.Stripe){r(window.Stripe);return}try{var t=G();if(!(t&&e)){if(!t)t=T(e);else if(t&&h!==null&&g!==null){var i;t.removeEventListener("load",h),t.removeEventListener("error",g),(i=t.parentNode)===null||i===void 0||i.removeChild(t),t=T(e)}}h=z(r,n),g=W(n),t.addEventListener("load",h),t.addEventListener("error",g)}catch(u){n(u);return}}),v.catch(function(r){return v=null,Promise.reject(r)}))},D=function(e,r,n){if(e===null)return null;var t=r[0],i=t.match(/^pk_test/),u=J(e.version),c=L;i&&u!==c&&console.warn("Stripe.js@".concat(u," was loaded on the page, but @stripe/stripe-js@").concat("7.7.0"," expected Stripe.js@").concat(c,". This may result in unexpected behavior. For more information, see https://docs.stripe.com/sdks/stripejs-versioning"));var m=e.apply(void 0,r);return O(m,n),m},S,P=!1,k=function(){return S||(S=X(null).catch(function(e){return S=null,Promise.reject(e)}),S)};Promise.resolve().then(function(){return k()}).catch(function(o){P||console.warn(o)});var F=function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];P=!0;var t=Date.now();return k().then(function(i){return D(i,r,t)})};const Q=A("cartStore",()=>{const o=E(0),e=b("jeton-quantity",0),r=E([]),n=j(()=>9*e.value),t=j(()=>e.value);return{cartQuantity:e,addresses:r,getCart:t,userTokenBalance:o,getTotalPrice:n,setBillingInfo:c=>{r.value.push(c)},creditTokensAfterPayment:c=>{o.value=o.value+c,console.log(`✅ ${e.value} jetons crédités. Nouveau solde: ${o.value}`)}}}),Y=()=>{const o=x("token"),e=U(),r=_(),n=q(),{professionalUser:t}=C(n),i=Q(),{creditTokensAfterPayment:u}=i;F(r.public.tokenStripe);const c=async l=>{var f,p,w,y;const s=t.value,d=l;if(localStorage.setItem("professional-uuid",((f=s==null?void 0:s.uuid)==null?void 0:f.replace(/[""]/g,""))||""),localStorage.setItem("token-session",o.value||""),!(s!=null&&s.uuid)){console.error("❌ No professional profile found");return}try{localStorage.setItem("jeton-quantity",JSON.stringify(d));const{data:a}=await R.post(`${r.public.apiUrl}/payments/token/${s.uuid}`,{quantity:l,professional_uuid:s.uuid},{headers:{Authorization:`Bearer ${o.value}`,"Content-Type":"application/json"}});if(a&&a.url)return window.location.href=a.url,a}catch(a){throw console.log("=== ERROR DETAILS ==="),console.log("Error message:",a.message),console.log("Error status:",(p=a.response)==null?void 0:p.status),console.log("Error headers:",(w=a.response)==null?void 0:w.headers),console.log("Error data:",(y=a.response)==null?void 0:y.data),console.log("Request that failed:",a.config),a}},m=async(l,s)=>{try{const{data:d}=await R.post(`${r.public.apiUrl}/credit/create`,{quantity:l,professionalUuid:s},{headers:{Authorization:`Bearer ${o.value}`,"Content-Type":"application/json"}});if(d)return localStorage.removeItem("jeton-quantity"),d}catch(d){console.log(d)}};return{createTokenSession:c,restoreAfterStripe:async l=>{const s=new URLSearchParams(window.location.search);if(s.has("session_id")||s.has("payment_intent")||e.query.success){const f=localStorage.getItem("jeton-quantity");try{if(f){const p=JSON.parse(f);u(p),l.uuid&&await m(p,l.uuid)}}catch(p){console.warn("LocalStorage restore failed:",p)}console.error("❌ All restore attempts failed")}else console.log("✅ Profile déjà présent, aucun besoin restock ")}}};export{Q as a,Y as u};
